# Operations Task Manager - Implementation Plan

**Feature:** Mobile-first task management system for farmers
**Target Users:** Farmers (primary), Managers (secondary)
**Platform:** Mobile-first web app, desktop accessible
**Status:** ğŸ“‹ Planning Phase

---

## Table of Contents

1. [Overview](#overview)
2. [User Flows](#user-flows)
3. [Database Schema](#database-schema)
4. [Backend Implementation](#backend-implementation)
5. [Frontend Implementation](#frontend-implementation)
6. [Task Auto-Generation Logic](#task-auto-generation-logic)
7. [Harvest Accumulation System](#harvest-accumulation-system)
8. [Notification System](#notification-system)
9. [Implementation Phases](#implementation-phases)
10. [Testing Strategy](#testing-strategy)

---

## Overview

### Purpose
Enable farmers to view and complete farming tasks through a simple, mobile-optimized interface. Tasks are auto-generated based on block state changes and crop timelines, or manually created by managers.

### Key Features
- âœ… Farm assignment system (farmers â†’ farms)
- âœ… Auto-generated tasks based on block lifecycle
- âœ… Mobile-first, touch-optimized UI
- âœ… Daily harvest with multiple entries per day
- âœ… Alert/issue reporting system
- âœ… Task history with 6-month retention
- âœ… Push notifications for task updates
- âœ… Manager oversight interface

### User Roles
1. **Farmer** - Views assigned farms, completes tasks, creates alerts
2. **Manager** - All farmer capabilities + create custom tasks, assign farmers, resolve alerts

---

## User Flows

### Farmer Flow
```
Login
  â†“
Operations Dashboard
  - See all assigned farms
  - See total pending task count
  â†“
Select Farm
  â†“
Farm Blocks View
  - See blocks with pending tasks
  - Task count per block
  â†“
Select Block
  â†“
Block Task List
  - See all tasks for block
  - Sorted by due date
  - [Report Issue] button
  â†“
Select Task
  â†“
Complete Task
  - For Harvest: Enter quantity, grade â†’ Submit
  - For Other: Add notes â†’ Mark complete
  â†“
Task Completed
  - Return to task list
  - See updated task count
```

### Manager Flow
```
Farm Dashboard
  â†“
Operations Tab (new)
  â†“
Manager Operations View
  - See all farm tasks
  - Filter by block/farmer
  - [Create Custom Task] button
  â†“
Options:
  1. Complete tasks (same as farmer)
  2. Create custom tasks (assign to specific farmer)
  3. View alerts and resolve
  4. Assign/unassign farmers to farm
```

---

## Database Schema

### Collection: `farmer_assignments`

Tracks which farmers are assigned to which farms.

```javascript
{
  _id: ObjectId,
  assignmentId: UUID,           // Primary key
  userId: UUID,                 // Farmer's user ID
  farmId: UUID,                 // Farm assigned to
  assignedBy: UUID,             // Manager who made assignment
  assignedAt: ISODate,          // When assigned
  isActive: Boolean,            // Can be deactivated without deletion
  createdAt: ISODate,
  updatedAt: ISODate
}
```

**Indexes:**
- `{ userId: 1, isActive: 1 }` - Get farmer's active assignments
- `{ farmId: 1, isActive: 1 }` - Get farm's active farmers
- `{ assignmentId: 1 }` - Unique constraint

**Sample:**
```javascript
{
  assignmentId: "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
  userId: "user-farmer-001",
  farmId: "farm-001",
  assignedBy: "user-manager-001",
  assignedAt: ISODate("2025-11-01T08:00:00Z"),
  isActive: true,
  createdAt: ISODate("2025-11-01T08:00:00Z"),
  updatedAt: ISODate("2025-11-01T08:00:00Z")
}
```

---

### Collection: `farm_tasks`

All farming tasks (auto-generated and manual).

```javascript
{
  _id: ObjectId,
  taskId: UUID,                 // Primary key
  farmId: UUID,                 // Farm this task belongs to
  blockId: UUID,                // Block this task is for

  // Task Details
  taskType: String,             // "planting" | "fruiting_check" | "harvest_readiness"
                                // | "daily_harvest" | "harvest_completion" | "cleaning" | "custom"
  title: String,                // "Daily Harvest - Tomato" | "Plant Lettuce Seeds"
  description: String,          // Optional detailed instructions

  // Scheduling
  scheduledDate: ISODate,       // When task should be started
  dueDate: ISODate,             // When task must be completed by

  // Status
  status: String,               // "pending" | "in_progress" | "completed" | "cancelled"
  priority: String,             // "low" | "medium" | "high" | "urgent"

  // Assignment
  autoGenerated: Boolean,       // true = system generated, false = manual
  generatedBy: String,          // "system" or userId if manual
  assignedTo: UUID,             // null for auto-tasks (any farmer can complete)
                                // userId for custom tasks (specific farmer)

  // Completion
  completedBy: UUID,            // User who completed (can be different from assignedTo)
  completedAt: ISODate,

  // Task Data
  taskData: {
    // For harvest tasks:
    harvestEntries: [           // Multiple entries per day
      {
        entryId: UUID,
        userId: UUID,           // Who logged this harvest
        timestamp: ISODate,     // When logged
        quantity: Number,       // kg
        grade: String,          // "A" | "B" | "C" | "D" | "Waste"
        notes: String           // Optional
      }
    ],
    totalHarvest: {             // Calculated at midnight
      totalQuantity: Number,
      gradeBreakdown: {
        A: Number,
        B: Number,
        C: Number,
        D: Number,
        Waste: Number
      },
      contributors: [UUID]      // All users who harvested
    },

    // For other tasks:
    notes: String,
    photos: [String],           // URLs to uploaded photos
    completionNotes: String
  },

  // Metadata
  createdAt: ISODate,
  updatedAt: ISODate
}
```

**Indexes:**
- `{ farmId: 1, status: 1, scheduledDate: 1 }` - Get farm's pending tasks sorted by date
- `{ blockId: 1, status: 1 }` - Get block's tasks
- `{ status: 1, dueDate: 1 }` - Find overdue tasks
- `{ assignedTo: 1, status: 1 }` - Get farmer's assigned custom tasks
- `{ taskType: 1, blockId: 1, status: 1 }` - Find specific task types for block

**Sample - Auto-Generated Daily Harvest:**
```javascript
{
  taskId: "task-harvest-001",
  farmId: "farm-001",
  blockId: "block-001",
  taskType: "daily_harvest",
  title: "Daily Harvest - Tomato",
  description: "Harvest ripe tomatoes, sort by quality",
  scheduledDate: ISODate("2025-11-18T06:00:00Z"),
  dueDate: ISODate("2025-11-18T23:59:59Z"),
  status: "in_progress",
  priority: "high",
  autoGenerated: true,
  generatedBy: "system",
  assignedTo: null,  // Any farmer can complete
  completedBy: null,
  completedAt: null,
  taskData: {
    harvestEntries: [
      {
        entryId: "entry-001",
        userId: "user-farmer-001",
        timestamp: ISODate("2025-11-18T08:30:00Z"),
        quantity: 25,
        grade: "A",
        notes: "Morning harvest from rows 1-5"
      },
      {
        entryId: "entry-002",
        userId: "user-farmer-002",
        timestamp: ISODate("2025-11-18T14:15:00Z"),
        quantity: 30,
        grade: "B",
        notes: null
      },
      {
        entryId: "entry-003",
        userId: "user-farmer-001",
        timestamp: ISODate("2025-11-18T17:45:00Z"),
        quantity: 5,
        grade: "Waste",
        notes: "Overripe tomatoes discarded"
      }
    ],
    totalHarvest: null  // Will be calculated at midnight
  },
  createdAt: ISODate("2025-11-15T00:00:00Z"),
  updatedAt: ISODate("2025-11-18T17:45:00Z")
}
```

**Sample - Manual Custom Task:**
```javascript
{
  taskId: "task-custom-001",
  farmId: "farm-001",
  blockId: "block-005",
  taskType: "custom",
  title: "Install New Irrigation Line",
  description: "Install drip irrigation on west side, connect to main line",
  scheduledDate: ISODate("2025-11-20T07:00:00Z"),
  dueDate: ISODate("2025-11-20T16:00:00Z"),
  status: "pending",
  priority: "high",
  autoGenerated: false,
  generatedBy: "user-manager-001",  // Manager who created it
  assignedTo: "user-farmer-003",     // Specific farmer assigned
  completedBy: null,
  completedAt: null,
  taskData: {
    notes: null,
    photos: [],
    completionNotes: null
  },
  createdAt: ISODate("2025-11-19T10:30:00Z"),
  updatedAt: ISODate("2025-11-19T10:30:00Z")
}
```

---

### Collection: `block_alerts`

Farmer-reported issues and alerts.

```javascript
{
  _id: ObjectId,
  alertId: UUID,                // Primary key
  farmId: UUID,
  blockId: UUID,

  // Alert Details
  alertType: String,            // "pest" | "disease" | "equipment" | "irrigation" | "other"
  severity: String,             // "info" | "warning" | "critical"
  title: String,                // Auto-generated from type or custom
  message: String,              // Farmer's description
  photos: [String],             // Optional photo URLs

  // Created By
  createdBy: UUID,              // Farmer who created alert
  createdAt: ISODate,

  // Status
  status: String,               // "open" | "acknowledged" | "resolved" | "closed"

  // Acknowledged
  acknowledgedBy: UUID,
  acknowledgedAt: ISODate,

  // Resolved
  resolvedBy: UUID,
  resolvedAt: ISODate,
  resolutionNotes: String,

  // Metadata
  updatedAt: ISODate
}
```

**Indexes:**
- `{ farmId: 1, status: 1, createdAt: -1 }` - Get farm's open alerts
- `{ blockId: 1, status: 1 }` - Get block's alerts
- `{ status: 1, severity: 1 }` - Find critical open alerts

**Sample:**
```javascript
{
  alertId: "alert-001",
  farmId: "farm-001",
  blockId: "block-002",
  alertType: "pest",
  severity: "warning",
  title: "Aphid Infestation Detected",
  message: "Found aphids on multiple tomato plants in rows 3-7. Spreading quickly.",
  photos: [
    "https://storage.a64core.com/alerts/alert-001-photo1.jpg",
    "https://storage.a64core.com/alerts/alert-001-photo2.jpg"
  ],
  createdBy: "user-farmer-001",
  createdAt: ISODate("2025-11-18T11:20:00Z"),
  status: "acknowledged",
  acknowledgedBy: "user-manager-001",
  acknowledgedAt: ISODate("2025-11-18T12:00:00Z"),
  resolvedBy: null,
  resolvedAt: null,
  resolutionNotes: null,
  updatedAt: ISODate("2025-11-18T12:00:00Z")
}
```

---

### Collection: `task_notifications`

Push notification queue for task updates.

```javascript
{
  _id: ObjectId,
  notificationId: UUID,
  userId: UUID,                 // Who to notify
  taskId: UUID,                 // Related task
  notificationType: String,     // "task_created" | "task_due_soon" | "task_overdue"
  title: String,
  message: String,
  read: Boolean,
  sentAt: ISODate,
  createdAt: ISODate
}
```

---

## Backend Implementation

### File Structure

```
src/modules/farm_manager/
â”œâ”€â”€ api/v1/
â”‚   â”œâ”€â”€ tasks.py              # NEW - Task management endpoints
â”‚   â”œâ”€â”€ farmer_assignments.py # NEW - Farmer assignment endpoints
â”‚   â””â”€â”€ alerts.py             # NEW - Alert endpoints
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ task.py               # NEW - Task models
â”‚   â”œâ”€â”€ farmer_assignment.py  # NEW - Assignment models
â”‚   â””â”€â”€ alert.py              # NEW - Alert models
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ task/
â”‚   â”‚   â”œâ”€â”€ task_service.py          # NEW - Task CRUD operations
â”‚   â”‚   â”œâ”€â”€ task_generator.py        # NEW - Auto-generation logic
â”‚   â”‚   â”œâ”€â”€ task_scheduler.py        # NEW - Rescheduling logic
â”‚   â”‚   â””â”€â”€ harvest_aggregator.py    # NEW - Daily harvest calculation
â”‚   â”œâ”€â”€ farmer_assignment_service.py # NEW
â”‚   â””â”€â”€ alert_service.py             # NEW
â””â”€â”€ utils/
    â””â”€â”€ notifications.py       # NEW - Push notification helper
```

---

### API Endpoints

#### Task Endpoints

**GET `/api/v1/farm/tasks/my-tasks`**
Get tasks for current user (farmers see farm tasks, managers see all).

**Query Parameters:**
- `farmId` (optional) - Filter by farm
- `status` (optional) - Filter by status
- `page`, `perPage` - Pagination

**Response:**
```json
{
  "data": {
    "tasks": [
      {
        "taskId": "task-001",
        "farmId": "farm-001",
        "farmName": "Al Ain Farm",
        "blockId": "block-001",
        "blockCode": "F001-002",
        "taskType": "daily_harvest",
        "title": "Daily Harvest - Tomato",
        "description": "Harvest ripe tomatoes",
        "scheduledDate": "2025-11-18T06:00:00Z",
        "dueDate": "2025-11-18T23:59:59Z",
        "status": "in_progress",
        "priority": "high",
        "assignedTo": null,
        "harvestEntriesCount": 2,
        "totalHarvestedToday": 55
      }
    ],
    "pagination": {
      "page": 1,
      "perPage": 20,
      "totalItems": 12,
      "totalPages": 1
    }
  },
  "message": "Tasks retrieved successfully",
  "success": true
}
```

---

**GET `/api/v1/farm/tasks/farm/{farmId}`**
Get all tasks for a farm (manager only).

**Response:** Same as above

---

**GET `/api/v1/farm/tasks/block/{blockId}`**
Get all tasks for a specific block.

**Response:**
```json
{
  "data": [
    {
      "taskId": "task-001",
      "taskType": "daily_harvest",
      "title": "Daily Harvest - Tomato",
      "status": "in_progress",
      "scheduledDate": "2025-11-18T06:00:00Z",
      "dueDate": "2025-11-18T23:59:59Z",
      "completedBy": null,
      "completedAt": null
    },
    {
      "taskId": "task-002",
      "taskType": "cleaning",
      "title": "Clean Block After Harvest",
      "status": "pending",
      "scheduledDate": "2025-11-25T08:00:00Z",
      "dueDate": "2025-11-26T18:00:00Z",
      "completedBy": null,
      "completedAt": null
    }
  ],
  "message": "Block tasks retrieved successfully",
  "success": true
}
```

---

**POST `/api/v1/farm/tasks`**
Create a custom task (manager only).

**Request Body:**
```json
{
  "farmId": "farm-001",
  "blockId": "block-001",
  "title": "Install Irrigation System",
  "description": "Install new drip irrigation on west side",
  "scheduledDate": "2025-11-20T07:00:00Z",
  "dueDate": "2025-11-20T16:00:00Z",
  "priority": "high",
  "assignedTo": "user-farmer-003"  // Optional, specific farmer
}
```

**Response:**
```json
{
  "data": {
    "taskId": "task-custom-001",
    "farmId": "farm-001",
    "blockId": "block-001",
    "taskType": "custom",
    "title": "Install Irrigation System",
    "status": "pending",
    "assignedTo": "user-farmer-003",
    "createdAt": "2025-11-19T10:30:00Z"
  },
  "message": "Custom task created successfully",
  "success": true
}
```

---

**PATCH `/api/v1/farm/tasks/{taskId}/complete`**
Complete a non-harvest task.

**Request Body:**
```json
{
  "notes": "Completed planting all seeds in rows 1-10",
  "photos": ["photo-url-1.jpg", "photo-url-2.jpg"]  // Optional
}
```

**Response:**
```json
{
  "data": {
    "taskId": "task-001",
    "status": "completed",
    "completedBy": "user-farmer-001",
    "completedAt": "2025-11-18T15:30:00Z"
  },
  "message": "Task completed successfully",
  "success": true
}
```

---

**POST `/api/v1/farm/tasks/{taskId}/harvest`**
Add a harvest entry to daily harvest task.

**Request Body:**
```json
{
  "quantity": 25,
  "grade": "A",  // "A" | "B" | "C" | "D" | "Waste"
  "notes": "Morning harvest from rows 1-5"  // Optional
}
```

**Response:**
```json
{
  "data": {
    "taskId": "task-harvest-001",
    "entryId": "entry-003",
    "quantity": 25,
    "grade": "A",
    "timestamp": "2025-11-18T08:30:00Z",
    "totalHarvestedToday": 80,
    "entriesCount": 3
  },
  "message": "Harvest entry added successfully",
  "success": true
}
```

---

**POST `/api/v1/farm/tasks/{taskId}/end-harvest`**
End daily harvest early (auto-cancel future harvest tasks).

**Request Body:**
```json
{
  "reason": "Crop reached end of production cycle early",
  "finalizeCurrentTask": true  // Complete today's task with current total
}
```

**Response:**
```json
{
  "data": {
    "taskId": "task-harvest-001",
    "status": "completed",
    "cancelledFutureTasks": 5,  // Number of future daily harvest tasks cancelled
    "totalHarvested": 80,
    "gradeBreakdown": {
      "A": 45,
      "B": 30,
      "C": 5,
      "Waste": 0
    }
  },
  "message": "Harvest ended early, future tasks cancelled",
  "success": true
}
```

---

**GET `/api/v1/farm/tasks/count`**
Get pending task count for current user.

**Query Parameters:**
- `farmId` (optional) - Count for specific farm

**Response:**
```json
{
  "data": {
    "total": 12,
    "byFarm": [
      {
        "farmId": "farm-001",
        "farmName": "Al Ain Farm",
        "count": 8
      },
      {
        "farmId": "farm-002",
        "farmName": "Dubai Farm",
        "count": 4
      }
    ],
    "byPriority": {
      "urgent": 2,
      "high": 5,
      "medium": 3,
      "low": 2
    }
  },
  "message": "Task count retrieved successfully",
  "success": true
}
```

---

#### Farmer Assignment Endpoints

**POST `/api/v1/farm/farmer-assignments`**
Assign a farmer to a farm (manager only).

**Request Body:**
```json
{
  "userId": "user-farmer-001",
  "farmId": "farm-001"
}
```

**Response:**
```json
{
  "data": {
    "assignmentId": "assignment-001",
    "userId": "user-farmer-001",
    "userName": "John Doe",
    "farmId": "farm-001",
    "farmName": "Al Ain Farm",
    "assignedBy": "user-manager-001",
    "assignedAt": "2025-11-19T10:00:00Z",
    "isActive": true
  },
  "message": "Farmer assigned to farm successfully",
  "success": true
}
```

---

**GET `/api/v1/farm/farmer-assignments/user/{userId}`**
Get all farm assignments for a farmer.

**Response:**
```json
{
  "data": [
    {
      "assignmentId": "assignment-001",
      "farmId": "farm-001",
      "farmName": "Al Ain Farm",
      "farmCode": "FCD2",
      "assignedAt": "2025-11-01T08:00:00Z",
      "pendingTasks": 8
    },
    {
      "assignmentId": "assignment-002",
      "farmId": "farm-002",
      "farmName": "Dubai Farm",
      "farmCode": "DXB1",
      "assignedAt": "2025-10-15T09:00:00Z",
      "pendingTasks": 4
    }
  ],
  "message": "Farmer assignments retrieved successfully",
  "success": true
}
```

---

**GET `/api/v1/farm/farmer-assignments/farm/{farmId}`**
Get all farmers assigned to a farm (manager only).

**Response:**
```json
{
  "data": [
    {
      "assignmentId": "assignment-001",
      "userId": "user-farmer-001",
      "userName": "John Doe",
      "userEmail": "john@example.com",
      "assignedAt": "2025-11-01T08:00:00Z",
      "tasksCompletedThisMonth": 45
    },
    {
      "assignmentId": "assignment-002",
      "userId": "user-farmer-002",
      "userName": "Jane Smith",
      "userEmail": "jane@example.com",
      "assignedAt": "2025-10-15T09:00:00Z",
      "tasksCompletedThisMonth": 38
    }
  ],
  "message": "Farm assignments retrieved successfully",
  "success": true
}
```

---

**DELETE `/api/v1/farm/farmer-assignments/{assignmentId}`**
Remove farmer from farm (manager only).

**Response:**
```json
{
  "data": {
    "assignmentId": "assignment-001",
    "isActive": false
  },
  "message": "Farmer removed from farm successfully",
  "success": true
}
```

---

#### Alert Endpoints

**POST `/api/v1/farm/alerts`**
Create an alert (farmer).

**Request Body:**
```json
{
  "blockId": "block-001",
  "alertType": "pest",  // "pest" | "disease" | "equipment" | "irrigation" | "other"
  "severity": "warning",  // "info" | "warning" | "critical"
  "message": "Found aphids on multiple tomato plants",
  "photos": ["photo-url-1.jpg"]  // Optional
}
```

**Response:**
```json
{
  "data": {
    "alertId": "alert-001",
    "blockId": "block-001",
    "blockCode": "F001-002",
    "alertType": "pest",
    "severity": "warning",
    "status": "open",
    "createdBy": "user-farmer-001",
    "createdAt": "2025-11-18T11:20:00Z"
  },
  "message": "Alert created successfully",
  "success": true
}
```

---

**GET `/api/v1/farm/alerts/block/{blockId}`**
Get all alerts for a block.

**Response:**
```json
{
  "data": [
    {
      "alertId": "alert-001",
      "alertType": "pest",
      "severity": "warning",
      "title": "Aphid Infestation Detected",
      "message": "Found aphids on multiple tomato plants",
      "status": "acknowledged",
      "createdBy": "John Doe",
      "createdAt": "2025-11-18T11:20:00Z",
      "acknowledgedBy": "Manager Name",
      "acknowledgedAt": "2025-11-18T12:00:00Z"
    }
  ],
  "message": "Block alerts retrieved successfully",
  "success": true
}
```

---

**GET `/api/v1/farm/alerts/farm/{farmId}`**
Get all alerts for a farm (manager only).

**Query Parameters:**
- `status` (optional) - Filter by status

**Response:** Same as above

---

**PATCH `/api/v1/farm/alerts/{alertId}/acknowledge`**
Acknowledge an alert (manager only).

**Response:**
```json
{
  "data": {
    "alertId": "alert-001",
    "status": "acknowledged",
    "acknowledgedBy": "user-manager-001",
    "acknowledgedAt": "2025-11-18T12:00:00Z"
  },
  "message": "Alert acknowledged successfully",
  "success": true
}
```

---

**PATCH `/api/v1/farm/alerts/{alertId}/resolve`**
Resolve an alert (manager only).

**Request Body:**
```json
{
  "resolutionNotes": "Applied organic pest control, monitoring for improvement"
}
```

**Response:**
```json
{
  "data": {
    "alertId": "alert-001",
    "status": "resolved",
    "resolvedBy": "user-manager-001",
    "resolvedAt": "2025-11-19T09:00:00Z"
  },
  "message": "Alert resolved successfully",
  "success": true
}
```

---

## Task Auto-Generation Logic

### Trigger: Block State Change `empty` â†’ `planned`

When a block transitions from `empty` to `planned`, the system automatically generates a series of tasks based on the block's timeline and plant data.

**Service:** `src/modules/farm_manager/services/task/task_generator.py`

**Function:** `generate_tasks_for_block(block_id: UUID, block: Block, plant_data: PlantData)`

**Generated Tasks:**

#### 1. Planting Task
```python
{
  "taskType": "planting",
  "title": f"Plant {plant_data.commonName} Seeds",
  "description": f"Plant {plant_data.commonName} in block {block.blockCode}",
  "scheduledDate": block.timeline.planting.startDate,
  "dueDate": block.timeline.planting.endDate,
  "priority": "high",
  "autoGenerated": True,
  "generatedBy": "system"
}
```

#### 2. Fruiting Check (if plant has fruiting stage)
```python
if plant_data.hasFruitingStage:
    {
      "taskType": "fruiting_check",
      "title": f"Check {plant_data.commonName} Fruiting Stage",
      "description": "Verify plants have entered fruiting stage",
      "scheduledDate": block.timeline.fruiting.startDate,
      "dueDate": block.timeline.fruiting.startDate + timedelta(days=2),
      "priority": "medium",
      "autoGenerated": True,
      "generatedBy": "system"
    }
```

#### 3. Harvest Readiness Check
```python
{
  "taskType": "harvest_readiness",
  "title": f"Check {plant_data.commonName} Harvest Readiness",
  "description": "Inspect crop for harvest readiness indicators",
  "scheduledDate": block.timeline.harvesting.startDate - timedelta(days=3),
  "dueDate": block.timeline.harvesting.startDate,
  "priority": "high",
  "autoGenerated": True,
  "generatedBy": "system"
}
```

#### 4. Daily Harvest Tasks (multiple recurring)
```python
harvest_start = block.timeline.harvesting.startDate
harvest_end = block.timeline.harvesting.endDate
current_date = harvest_start

daily_tasks = []
while current_date <= harvest_end:
    task = {
      "taskType": "daily_harvest",
      "title": f"Daily Harvest - {plant_data.commonName}",
      "description": f"Harvest ripe {plant_data.commonName}, sort by quality grade",
      "scheduledDate": current_date + timedelta(hours=6),  # 6 AM
      "dueDate": current_date + timedelta(hours=23, minutes=59),  # 11:59 PM
      "priority": "high",
      "autoGenerated": True,
      "generatedBy": "system",
      "taskData": {
        "harvestEntries": [],
        "totalHarvest": None
      }
    }
    daily_tasks.append(task)
    current_date += timedelta(days=1)
```

**Example:** If harvest period is 10 days, generates 10 daily harvest tasks.

#### 5. Harvest Completion Check
```python
{
  "taskType": "harvest_completion",
  "title": f"Complete {plant_data.commonName} Harvest",
  "description": "Verify all harvestable crop has been collected",
  "scheduledDate": block.timeline.harvesting.endDate,
  "dueDate": block.timeline.harvesting.endDate + timedelta(days=1),
  "priority": "high",
  "autoGenerated": True,
  "generatedBy": "system"
}
```

#### 6. Cleaning Task
```python
{
  "taskType": "cleaning",
  "title": f"Clean Block {block.blockCode}",
  "description": "Remove plant debris, sanitize block for next planting",
  "scheduledDate": block.timeline.cleaning.startDate,
  "dueDate": block.timeline.cleaning.endDate,
  "priority": "medium",
  "autoGenerated": True,
  "generatedBy": "system"
}
```

---

### Task Rescheduling on Timeline Updates

**Trigger:** Block timeline dates are updated (early/late state transitions)

**Service:** `src/modules/farm_manager/services/task/task_scheduler.py`

**Function:** `reschedule_block_tasks(block_id: UUID, old_timeline: dict, new_timeline: dict)`

**Logic:**
```python
async def reschedule_block_tasks(block_id: UUID, old_timeline: dict, new_timeline: dict):
    # Get all pending and in_progress tasks for this block
    tasks = await get_block_tasks(
        block_id,
        status=["pending", "in_progress"],
        auto_generated_only=True
    )

    for task in tasks:
        new_date = calculate_new_task_date(
            task_type=task.taskType,
            old_timeline=old_timeline,
            new_timeline=new_timeline
        )

        # Only reschedule if change is significant (> 12 hours)
        if abs(new_date - task.scheduledDate).total_seconds() > 43200:
            await update_task_schedule(
                task_id=task.taskId,
                new_scheduled_date=new_date,
                new_due_date=calculate_due_date(task.taskType, new_date)
            )

            # Send notification to farmers
            await send_task_rescheduled_notification(task, new_date)
```

**Date Calculation:**
```python
def calculate_new_task_date(task_type: str, old_timeline: dict, new_timeline: dict) -> datetime:
    if task_type == "planting":
        return new_timeline["planting"]["startDate"]

    elif task_type == "fruiting_check":
        return new_timeline["fruiting"]["startDate"]

    elif task_type == "harvest_readiness":
        return new_timeline["harvesting"]["startDate"] - timedelta(days=3)

    elif task_type == "daily_harvest":
        # Recalculate based on new harvest period
        old_harvest_start = old_timeline["harvesting"]["startDate"]
        new_harvest_start = new_timeline["harvesting"]["startDate"]

        # Shift by same number of days
        day_offset = (new_harvest_start - old_harvest_start).days
        return task.scheduledDate + timedelta(days=day_offset)

    elif task_type == "harvest_completion":
        return new_timeline["harvesting"]["endDate"]

    elif task_type == "cleaning":
        return new_timeline["cleaning"]["startDate"]
```

---

## Harvest Accumulation System

### Multiple Entries Per Day

Daily harvest tasks allow multiple farmers to log harvest entries throughout the day. Each entry is stored separately with user info, timestamp, quantity, and grade.

**Flow:**
```
Farmer 1 (8:30 AM)  â†’ Logs 25 kg Grade A
Farmer 2 (11:15 AM) â†’ Logs 30 kg Grade B
Farmer 1 (2:45 PM)  â†’ Logs 15 kg Grade A
Farmer 3 (5:30 PM)  â†’ Logs 10 kg Grade C
                      â†“
                At Midnight (00:00)
                      â†“
            System Calculates Total
                      â†“
Task marked complete with:
- Total: 80 kg
- Grade A: 40 kg (Farmers 1)
- Grade B: 30 kg (Farmer 2)
- Grade C: 10 kg (Farmer 3)
- Contributors: [Farmer 1, Farmer 2, Farmer 3]
```

### Midnight Aggregation Job

**Service:** `src/modules/farm_manager/services/task/harvest_aggregator.py`

**Scheduled Job:** Runs daily at 00:00 (midnight)

**Function:** `aggregate_daily_harvests()`

**Implementation:**
```python
from apscheduler.schedulers.asyncio import AsyncIOScheduler
from datetime import datetime, timedelta

scheduler = AsyncIOScheduler()

@scheduler.scheduled_job('cron', hour=0, minute=0)
async def aggregate_daily_harvests():
    """
    Run at midnight to finalize yesterday's daily harvest tasks
    """
    yesterday = datetime.now().date() - timedelta(days=1)

    # Get all daily_harvest tasks scheduled for yesterday that are in_progress
    tasks = await get_tasks_by_type_and_date(
        task_type="daily_harvest",
        scheduled_date=yesterday,
        status="in_progress"
    )

    for task in tasks:
        if not task.taskData.harvestEntries:
            # No harvest logged, mark as completed with 0
            await complete_task(
                task_id=task.taskId,
                completion_data={
                    "totalHarvest": {
                        "totalQuantity": 0,
                        "gradeBreakdown": {"A": 0, "B": 0, "C": 0, "D": 0, "Waste": 0},
                        "contributors": []
                    }
                },
                completed_by="system"
            )
        else:
            # Calculate totals
            total_quantity = 0
            grade_breakdown = {"A": 0, "B": 0, "C": 0, "D": 0, "Waste": 0}
            contributors = set()

            for entry in task.taskData.harvestEntries:
                total_quantity += entry.quantity
                grade_breakdown[entry.grade] += entry.quantity
                contributors.add(entry.userId)

            # Update task with totals
            await complete_task(
                task_id=task.taskId,
                completion_data={
                    "totalHarvest": {
                        "totalQuantity": total_quantity,
                        "gradeBreakdown": grade_breakdown,
                        "contributors": list(contributors)
                    }
                },
                completed_by="system"
            )

            logger.info(
                f"Aggregated harvest for task {task.taskId}: "
                f"{total_quantity} kg by {len(contributors)} farmers"
            )
```

**Startup:**
```python
# In src/main.py startup event
scheduler.start()
logger.info("Harvest aggregation scheduler started")
```

---

### Early Harvest Termination

When a manager or farmer ends harvest early:

1. **Finalize Current Day's Task:**
   - Calculate totals from entries logged so far
   - Mark task as completed
   - Store final harvest data

2. **Cancel Future Daily Harvest Tasks:**
   ```python
   async def end_harvest_early(task_id: UUID, reason: str, user_id: UUID):
       task = await get_task(task_id)
       block_id = task.blockId

       # Finalize current task
       if task.taskData.harvestEntries:
           await finalize_harvest_task(task_id)

       # Get all future daily_harvest tasks for this block
       future_tasks = await get_future_harvest_tasks(
           block_id=block_id,
           after_date=datetime.now().date()
       )

       # Cancel them
       cancelled_count = 0
       for future_task in future_tasks:
           await cancel_task(
               task_id=future_task.taskId,
               reason=f"Harvest ended early: {reason}",
               cancelled_by=user_id
           )
           cancelled_count += 1

       return {
           "currentTaskFinalized": True,
           "futureTasksCancelled": cancelled_count,
           "reason": reason
       }
   ```

---

## Notification System

### Push Notifications

Farmers receive notifications for:
1. **New Task Assigned** - When custom task is assigned to them
2. **Task Due Soon** - 1 day before task due date
3. **Task Overdue** - When task passes due date without completion
4. **Task Rescheduled** - When auto-task dates change
5. **Alert Acknowledged** - When manager acknowledges their alert
6. **Alert Resolved** - When manager resolves their alert

**Service:** `src/modules/farm_manager/utils/notifications.py`

**Implementation:**
```python
from typing import List, Optional
import logging

logger = logging.getLogger(__name__)

async def send_task_notification(
    user_ids: List[str],
    notification_type: str,
    task: Task,
    custom_message: Optional[str] = None
):
    """
    Send push notification to users

    For now, creates in-app notification
    TODO: Integrate with push notification service (Firebase, OneSignal, etc.)
    """

    # Define notification templates
    templates = {
        "task_created": {
            "title": "New Task Assigned",
            "message": f"You have a new task: {task.title}"
        },
        "task_due_soon": {
            "title": "Task Due Tomorrow",
            "message": f"{task.title} is due tomorrow"
        },
        "task_overdue": {
            "title": "Task Overdue",
            "message": f"{task.title} is overdue"
        },
        "task_rescheduled": {
            "title": "Task Rescheduled",
            "message": custom_message or f"{task.title} has been rescheduled"
        }
    }

    template = templates.get(notification_type, {
        "title": "Task Update",
        "message": custom_message or "Task has been updated"
    })

    # Create notification records
    for user_id in user_ids:
        notification = {
            "notificationId": generate_uuid(),
            "userId": user_id,
            "taskId": task.taskId,
            "notificationType": notification_type,
            "title": template["title"],
            "message": template["message"],
            "read": False,
            "sentAt": datetime.now(),
            "createdAt": datetime.now()
        }

        await db.task_notifications.insert_one(notification)

        # TODO: Send actual push notification via service
        # await push_service.send(user_id, template["title"], template["message"])

    logger.info(f"Sent {notification_type} notification to {len(user_ids)} users")
```

**Daily Notification Job:**
```python
@scheduler.scheduled_job('cron', hour=8, minute=0)  # 8 AM daily
async def send_daily_task_reminders():
    """Send notifications for tasks due today or tomorrow"""

    tomorrow = datetime.now().date() + timedelta(days=1)

    # Get tasks due tomorrow
    due_soon_tasks = await get_tasks_by_due_date(tomorrow)

    for task in due_soon_tasks:
        # Get farmers assigned to this farm
        farmers = await get_farm_farmers(task.farmId)
        farmer_ids = [f.userId for f in farmers]

        if task.assignedTo:
            # Custom task, notify specific farmer
            await send_task_notification(
                user_ids=[task.assignedTo],
                notification_type="task_due_soon",
                task=task
            )
        else:
            # Auto task, notify all farmers
            await send_task_notification(
                user_ids=farmer_ids,
                notification_type="task_due_soon",
                task=task
            )
```

---

## Frontend Implementation

### Routes

```tsx
// frontend/user-portal/src/App.tsx
<Route path="/operations" element={<OperationsDashboard />} />
<Route path="/operations/farm/:farmId" element={<FarmBlocksView />} />
<Route path="/operations/block/:blockId" element={<BlockTaskList />} />
<Route path="/operations/task/:taskId" element={<TaskDetailView />} />

// Manager route (inside farm dashboard)
<Route path="/farm/operations/:farmId" element={<ManagerOperationsView />} />
```

### Pages

#### 1. Operations Dashboard
**File:** `frontend/user-portal/src/pages/operations/OperationsDashboard.tsx`

**Features:**
- Display all farms farmer is assigned to
- Show pending task count per farm
- Show total pending task count
- Pull-to-refresh
- Large, touch-friendly farm cards

**Mobile Layout (320px - 428px):**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† Operations                    â”‚
â”‚ Pull down to refresh â†“          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“‹ My Tasks                     â”‚
â”‚ 12 Pending Tasks                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸï¸ My Farms (3)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸï¸ Al Ain Farm              â”‚ â”‚
â”‚ â”‚ FCD2                        â”‚ â”‚
â”‚ â”‚                             â”‚ â”‚
â”‚ â”‚ ğŸ“‹ 8 pending tasks          â”‚ â”‚
â”‚ â”‚ ğŸŒ± 2 blocks active          â”‚ â”‚
â”‚ â”‚                             â”‚ â”‚
â”‚ â”‚ [View Tasks â†’]              â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸï¸ Dubai Farm              â”‚ â”‚
â”‚ â”‚ DXB1                        â”‚ â”‚
â”‚ â”‚                             â”‚ â”‚
â”‚ â”‚ ğŸ“‹ 4 pending tasks          â”‚ â”‚
â”‚ â”‚ ğŸŒ± 1 block active           â”‚ â”‚
â”‚ â”‚                             â”‚ â”‚
â”‚ â”‚ [View Tasks â†’]              â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Component:**
```tsx
export const OperationsDashboard: React.FC = () => {
  const { data: farms, isLoading, refetch } = useQuery({
    queryKey: ['farmer-farms'],
    queryFn: () => api.get('/api/v1/farm/farmer-assignments/user/me')
  });

  const { data: taskCount } = useQuery({
    queryKey: ['task-count'],
    queryFn: () => api.get('/api/v1/farm/tasks/count'),
    refetchInterval: 30000 // Poll every 30s
  });

  return (
    <Container>
      <Header>
        <BackButton />
        <Title>Operations</Title>
      </Header>

      <PullToRefresh onRefresh={refetch}>
        <TaskSummary>
          <Icon>ğŸ“‹</Icon>
          <div>
            <TaskCount>{taskCount?.total || 0}</TaskCount>
            <TaskLabel>Pending Tasks</TaskLabel>
          </div>
        </TaskSummary>

        <SectionHeader>
          ğŸï¸ My Farms ({farms?.length || 0})
        </SectionHeader>

        {farms?.map(farm => (
          <FarmCard key={farm.farmId} to={`/operations/farm/${farm.farmId}`}>
            <FarmIcon>ğŸï¸</FarmIcon>
            <FarmInfo>
              <FarmName>{farm.farmName}</FarmName>
              <FarmCode>{farm.farmCode}</FarmCode>
              <FarmStats>
                <Stat>ğŸ“‹ {farm.pendingTasks} pending tasks</Stat>
                <Stat>ğŸŒ± {farm.activeBlocks} blocks active</Stat>
              </FarmStats>
            </FarmInfo>
            <Arrow>â†’</Arrow>
          </FarmCard>
        ))}
      </PullToRefresh>
    </Container>
  );
};
```

---

#### 2. Farm Blocks View
**File:** `frontend/user-portal/src/pages/operations/FarmBlocksView.tsx`

**Features:**
- Show all blocks with pending tasks
- Display block code, crop, state
- Show task count per block
- Filter by crop or state

**Mobile Layout:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† Al Ain Farm                   â”‚
â”‚ Active Blocks (2)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [Search or filter blocks...]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ F001-002                    â”‚ â”‚
â”‚ â”‚ ğŸŒ¿ Growing                  â”‚ â”‚
â”‚ â”‚ ğŸ… Tomato                   â”‚ â”‚
â”‚ â”‚                             â”‚ â”‚
â”‚ â”‚ â±ï¸ 3 tasks pending          â”‚ â”‚
â”‚ â”‚ â€¢ Daily Harvest             â”‚ â”‚
â”‚ â”‚ â€¢ Harvest Completion        â”‚ â”‚
â”‚ â”‚ â€¢ Cleaning                  â”‚ â”‚
â”‚ â”‚                             â”‚ â”‚
â”‚ â”‚ [View Tasks â†’]              â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ F001-005                    â”‚ â”‚
â”‚ â”‚ ğŸ”µ Planned                  â”‚ â”‚
â”‚ â”‚ ğŸ¥¬ Lettuce                  â”‚ â”‚
â”‚ â”‚                             â”‚ â”‚
â”‚ â”‚ â±ï¸ 1 task pending           â”‚ â”‚
â”‚ â”‚ â€¢ Planting                  â”‚ â”‚
â”‚ â”‚                             â”‚ â”‚
â”‚ â”‚ [View Tasks â†’]              â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

#### 3. Block Task List
**File:** `frontend/user-portal/src/pages/operations/BlockTaskList.tsx`

**Features:**
- List all tasks for block (completed and pending)
- Sort by due date (soonest first)
- Visual status indicators (âœ“ completed, â±ï¸ pending, ğŸ”´ overdue)
- Swipe-to-complete action
- **[ğŸš¨ Report Issue]** button prominent at top

**Mobile Layout:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† F001-002 â€¢ Tomato             â”‚
â”‚ Tasks (5)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [ğŸš¨ Report Issue on Block]      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Completed (2)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ“ Planting                      â”‚
â”‚   Completed 15 days ago         â”‚
â”‚   by John Doe                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ“ Fruiting Check                â”‚
â”‚   Completed 5 days ago          â”‚
â”‚   by Jane Smith                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Pending (3)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â±ï¸ Daily Harvest                â”‚
â”‚ ğŸ”´ Overdue by 2 hours           â”‚
â”‚ Due: Today 11:59 PM             â”‚
â”‚ 2 entries logged (55 kg)        â”‚
â”‚                                 â”‚
â”‚ [Complete Task â†’]               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â±ï¸ Harvest Completion           â”‚
â”‚ Due in 3 days                   â”‚
â”‚                                 â”‚
â”‚ [View Details â†’]                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â±ï¸ Cleaning                     â”‚
â”‚ Due in 7 days                   â”‚
â”‚                                 â”‚
â”‚ [View Details â†’]                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Component with Swipe Actions:**
```tsx
export const BlockTaskList: React.FC = () => {
  const { blockId } = useParams();
  const [showAlertModal, setShowAlertModal] = useState(false);

  const { data: tasks } = useQuery({
    queryKey: ['block-tasks', blockId],
    queryFn: () => api.get(`/api/v1/farm/tasks/block/${blockId}`)
  });

  const pendingTasks = tasks?.filter(t => t.status !== 'completed') || [];
  const completedTasks = tasks?.filter(t => t.status === 'completed') || [];

  return (
    <Container>
      <Header>
        <BackButton />
        <Title>{block.blockCode} â€¢ {block.crop}</Title>
      </Header>

      <AlertButton onClick={() => setShowAlertModal(true)}>
        ğŸš¨ Report Issue on Block
      </AlertButton>

      <TaskSection>
        <SectionTitle>Pending ({pendingTasks.length})</SectionTitle>

        {pendingTasks.map(task => (
          <SwipeableTaskCard
            key={task.taskId}
            task={task}
            onSwipeRight={() => {
              if (task.taskType === 'daily_harvest') {
                navigate(`/operations/task/${task.taskId}`);
              } else {
                openCompleteModal(task);
              }
            }}
          />
        ))}
      </TaskSection>

      <TaskSection>
        <SectionTitle>Completed ({completedTasks.length})</SectionTitle>

        {completedTasks.map(task => (
          <CompletedTaskCard key={task.taskId} task={task} />
        ))}
      </TaskSection>

      {showAlertModal && (
        <CreateAlertModal
          blockId={blockId}
          onClose={() => setShowAlertModal(false)}
        />
      )}
    </Container>
  );
};
```

---

#### 4. Task Completion Modal
**File:** `frontend/user-portal/src/components/operations/TaskCompletionModal.tsx`

**For Harvest Tasks:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Daily Harvest - Tomato     [âœ•]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Today's Harvest Summary:        â”‚
â”‚ 55 kg logged in 2 entries       â”‚
â”‚ â€¢ 25 kg Grade A (John)          â”‚
â”‚ â€¢ 30 kg Grade B (Jane)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Add New Entry                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Quantity (kg) *                 â”‚
â”‚ [_____________] ğŸ”¢              â”‚
â”‚                                 â”‚
â”‚ Grade *                         â”‚
â”‚ [ A ] [ B ] [ C ] [ D ] [Waste] â”‚
â”‚                                 â”‚
â”‚ Notes (optional)                â”‚
â”‚ [_____________________________] â”‚
â”‚                                 â”‚
â”‚ Photos (optional)               â”‚
â”‚ [ğŸ“· Add Photo]                  â”‚
â”‚                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ âœ“ Add Harvest Entry         â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â¹ï¸ End Harvest Early        â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**For Other Tasks:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Complete Planting          [âœ•]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Notes (optional)                â”‚
â”‚ [_____________________________] â”‚
â”‚ [_____________________________] â”‚
â”‚                                 â”‚
â”‚ Photos (optional)               â”‚
â”‚ [ğŸ“· Add Photo]                  â”‚
â”‚                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ âœ“ Mark Complete             â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Component:**
```tsx
export const TaskCompletionModal: React.FC<{task: Task}> = ({task}) => {
  const [quantity, setQuantity] = useState('');
  const [grade, setGrade] = useState<'A' | 'B' | 'C' | 'D' | 'Waste'>('A');
  const [notes, setNotes] = useState('');

  const { mutate: addHarvestEntry } = useMutation({
    mutationFn: (data) => api.post(`/api/v1/farm/tasks/${task.taskId}/harvest`, data),
    onSuccess: () => {
      toast.success('Harvest entry added');
      setQuantity('');
      setNotes('');
    }
  });

  const { mutate: endHarvest } = useMutation({
    mutationFn: (reason) => api.post(`/api/v1/farm/tasks/${task.taskId}/end-harvest`, {reason}),
    onSuccess: () => {
      toast.success('Harvest ended, future tasks cancelled');
      onClose();
    }
  });

  const handleAddEntry = () => {
    if (!quantity || parseFloat(quantity) <= 0) {
      toast.error('Please enter valid quantity');
      return;
    }

    addHarvestEntry({
      quantity: parseFloat(quantity),
      grade,
      notes
    });
  };

  return (
    <Modal>
      <Header>
        <Title>{task.title}</Title>
        <CloseButton onClick={onClose}>âœ•</CloseButton>
      </Header>

      {task.taskType === 'daily_harvest' && (
        <>
          <Summary>
            <SummaryTitle>Today's Harvest Summary:</SummaryTitle>
            <SummaryText>
              {task.totalHarvestedToday} kg logged in {task.harvestEntriesCount} entries
            </SummaryText>
            {task.taskData.harvestEntries.map(entry => (
              <EntryItem key={entry.entryId}>
                â€¢ {entry.quantity} kg Grade {entry.grade} ({entry.userName})
              </EntryItem>
            ))}
          </Summary>

          <Divider />

          <FormSection>
            <Label>Quantity (kg) *</Label>
            <Input
              type="number"
              value={quantity}
              onChange={(e) => setQuantity(e.target.value)}
              placeholder="Enter harvest quantity"
              inputMode="decimal"
            />
          </FormSection>

          <FormSection>
            <Label>Grade *</Label>
            <GradeButtons>
              {['A', 'B', 'C', 'D', 'Waste'].map(g => (
                <GradeButton
                  key={g}
                  selected={grade === g}
                  onClick={() => setGrade(g)}
                >
                  {g}
                </GradeButton>
              ))}
            </GradeButtons>
          </FormSection>

          <FormSection>
            <Label>Notes (optional)</Label>
            <TextArea
              value={notes}
              onChange={(e) => setNotes(e.target.value)}
              placeholder="Add any notes about this harvest..."
              rows={3}
            />
          </FormSection>

          <PrimaryButton onClick={handleAddEntry}>
            âœ“ Add Harvest Entry
          </PrimaryButton>

          <SecondaryButton onClick={() => {
            const reason = prompt('Reason for ending harvest early:');
            if (reason) endHarvest(reason);
          }}>
            â¹ï¸ End Harvest Early
          </SecondaryButton>
        </>
      )}

      {task.taskType !== 'daily_harvest' && (
        <>
          <FormSection>
            <Label>Notes (optional)</Label>
            <TextArea
              value={notes}
              onChange={(e) => setNotes(e.target.value)}
              placeholder="Add completion notes..."
              rows={4}
            />
          </FormSection>

          <PrimaryButton onClick={() => completeTask({notes})}>
            âœ“ Mark Complete
          </PrimaryButton>
        </>
      )}
    </Modal>
  );
};
```

---

#### 5. Alert Creation Modal
**File:** `frontend/user-portal/src/components/operations/CreateAlertModal.tsx`

**Layout:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Report Issue               [âœ•]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Issue Type *                    â”‚
â”‚                                 â”‚
â”‚ [ğŸ› Pest    ] [ğŸ¦  Disease   ]   â”‚
â”‚ [ğŸ”§ Equipment] [ğŸ’§ Irrigation]  â”‚
â”‚ [â“ Other   ]                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Severity *                      â”‚
â”‚                                 â”‚
â”‚ [â„¹ï¸ Info] [âš ï¸ Warning] [ğŸš¨ Critical]
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Description *                   â”‚
â”‚ [_____________________________] â”‚
â”‚ [_____________________________] â”‚
â”‚ [_____________________________] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Photos (optional)               â”‚
â”‚ [ğŸ“· Add Photos]                 â”‚
â”‚ [photo1.jpg] [photo2.jpg]       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸš¨ Submit Alert             â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Component:**
```tsx
export const CreateAlertModal: React.FC<{blockId: string}> = ({blockId, onClose}) => {
  const [alertType, setAlertType] = useState<AlertType>('pest');
  const [severity, setSeverity] = useState<Severity>('warning');
  const [message, setMessage] = useState('');
  const [photos, setPhotos] = useState<File[]>([]);

  const { mutate: createAlert } = useMutation({
    mutationFn: (data) => api.post('/api/v1/farm/alerts', data),
    onSuccess: () => {
      toast.success('Alert submitted successfully');
      onClose();
    }
  });

  const handleSubmit = async () => {
    if (!message.trim()) {
      toast.error('Please describe the issue');
      return;
    }

    // Upload photos if any
    const photoUrls = await uploadPhotos(photos);

    createAlert({
      blockId,
      alertType,
      severity,
      message,
      photos: photoUrls
    });
  };

  return (
    <Modal>
      <Header>
        <Title>Report Issue</Title>
        <CloseButton onClick={onClose}>âœ•</CloseButton>
      </Header>

      <FormSection>
        <Label>Issue Type *</Label>
        <TypeGrid>
          <TypeButton
            selected={alertType === 'pest'}
            onClick={() => setAlertType('pest')}
          >
            ğŸ› Pest
          </TypeButton>
          <TypeButton
            selected={alertType === 'disease'}
            onClick={() => setAlertType('disease')}
          >
            ğŸ¦  Disease
          </TypeButton>
          <TypeButton
            selected={alertType === 'equipment'}
            onClick={() => setAlertType('equipment')}
          >
            ğŸ”§ Equipment
          </TypeButton>
          <TypeButton
            selected={alertType === 'irrigation'}
            onClick={() => setAlertType('irrigation')}
          >
            ğŸ’§ Irrigation
          </TypeButton>
          <TypeButton
            selected={alertType === 'other'}
            onClick={() => setAlertType('other')}
          >
            â“ Other
          </TypeButton>
        </TypeGrid>
      </FormSection>

      <FormSection>
        <Label>Severity *</Label>
        <SeverityButtons>
          <SeverityButton
            selected={severity === 'info'}
            onClick={() => setSeverity('info')}
          >
            â„¹ï¸ Info
          </SeverityButton>
          <SeverityButton
            selected={severity === 'warning'}
            onClick={() => setSeverity('warning')}
          >
            âš ï¸ Warning
          </SeverityButton>
          <SeverityButton
            selected={severity === 'critical'}
            onClick={() => setSeverity('critical')}
          >
            ğŸš¨ Critical
          </SeverityButton>
        </SeverityButtons>
      </FormSection>

      <FormSection>
        <Label>Description *</Label>
        <TextArea
          value={message}
          onChange={(e) => setMessage(e.target.value)}
          placeholder="Describe the issue in detail..."
          rows={5}
        />
      </FormSection>

      <FormSection>
        <Label>Photos (optional)</Label>
        <PhotoUpload
          photos={photos}
          onChange={setPhotos}
          maxPhotos={5}
        />
      </FormSection>

      <SubmitButton onClick={handleSubmit}>
        ğŸš¨ Submit Alert
      </SubmitButton>
    </Modal>
  );
};
```

---

### Sidebar Task Counter

**File:** `frontend/user-portal/src/components/layout/Sidebar.tsx`

**Update:**
```tsx
export const Sidebar: React.FC = () => {
  const { data: taskCount } = useQuery({
    queryKey: ['task-count'],
    queryFn: () => api.get('/api/v1/farm/tasks/count'),
    refetchInterval: 30000, // Poll every 30s
    enabled: user?.role === 'farmer' || user?.role === 'manager'
  });

  return (
    <SidebarContainer>
      {/* ... other links ... */}

      <SidebarLink to="/operations">
        <Icon>ğŸ“‹</Icon>
        <Text>Operations</Text>
        {taskCount && taskCount.total > 0 && (
          <Badge>{taskCount.total}</Badge>
        )}
      </SidebarLink>

      {/* ... other links ... */}
    </SidebarContainer>
  );
};

const Badge = styled.span`
  background: var(--color-error);
  color: white;
  font-size: 12px;
  font-weight: 600;
  padding: 2px 8px;
  border-radius: 12px;
  margin-left: auto;
`;
```

---

## Manager Integration

### Manager Operations View
**File:** `frontend/user-portal/src/pages/farm/ManagerOperationsView.tsx`

**Features:**
- View all farm tasks (not just assigned)
- Create custom tasks and assign to farmers
- View task completion analytics
- Monitor alerts and resolve them
- Assign/remove farmers from farm

**Desktop/Tablet Layout:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Farm Operations â€¢ Al Ain Farm                   â”‚
â”‚ [+ Create Custom Task] [Assign Farmers]         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Filters: [All Tasks â–¼] [All Blocks â–¼] [All Farmers â–¼]
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Pending Tasks (12)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â±ï¸ Daily Harvest - Tomato                       â”‚
â”‚ F001-002 â€¢ Due today 11:59 PM                   â”‚
â”‚ ğŸ‘¤ Not assigned (any farmer)                    â”‚
â”‚ 55 kg logged in 2 entries                       â”‚
â”‚ [View Details]                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â±ï¸ Install Irrigation System                    â”‚
â”‚ F001-005 â€¢ Due Nov 20 4:00 PM                   â”‚
â”‚ ğŸ‘¤ Assigned to: John Doe                        â”‚
â”‚ Custom task                                     â”‚
â”‚ [View Details] [Reassign]                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ...                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Implementation Phases

### Phase 1: Database & Backend Foundation (Week 1)
**Days 1-3:**
- Create MongoDB collections (farmer_assignments, farm_tasks, block_alerts)
- Create Pydantic models (Task, FarmerAssignment, Alert)
- Set up database indexes

**Days 4-5:**
- Implement FarmerAssignmentService
- Implement TaskService (CRUD operations)
- Implement AlertService

### Phase 2: Task Auto-Generation (Week 2)
**Days 1-2:**
- Implement TaskGeneratorService
- Create task generation logic for block state changes
- Test task generation with different plant types

**Days 3-4:**
- Implement TaskSchedulerService
- Create task rescheduling logic
- Test rescheduling when timelines change

**Day 5:**
- Implement HarvestAggregatorService
- Set up APScheduler for midnight aggregation
- Test harvest entry accumulation

### Phase 3: Backend API Endpoints (Week 2-3)
**Days 1-2:**
- Implement task endpoints (GET my-tasks, GET block tasks, etc.)
- Implement harvest endpoints (POST harvest entry, end harvest)
- Add authentication middleware

**Days 3-4:**
- Implement farmer assignment endpoints
- Implement alert endpoints
- Add authorization checks (farmer vs manager)

**Day 5:**
- Write API unit tests
- Write integration tests
- Test with Postman/Thunder Client

### Phase 4: Frontend UI - Mobile First (Week 3-4)
**Days 1-2:**
- Create OperationsDashboard page
- Create FarmBlocksView page
- Implement pull-to-refresh

**Days 3-4:**
- Create BlockTaskList page
- Implement swipe-to-complete
- Create TaskCompletionModal (harvest + regular)

**Days 5-7:**
- Create CreateAlertModal
- Add task counter to sidebar
- Implement responsive design (mobile â†’ desktop)
- Add loading states and error handling

### Phase 5: Manager Features (Week 4)
**Days 1-2:**
- Create ManagerOperationsView
- Implement create custom task form
- Implement farmer assignment interface

**Days 3:**
- Add alert management (view, acknowledge, resolve)
- Add task analytics dashboard

### Phase 6: Notifications & Polish (Week 4)
**Days 1-2:**
- Implement push notification service
- Set up APScheduler for daily reminders
- Test notification delivery

**Days 3-4:**
- UI polish (animations, transitions)
- Accessibility improvements (ARIA labels, keyboard nav)
- Performance optimization

**Day 5:**
- End-to-end testing
- User acceptance testing
- Bug fixes

---

## Testing Strategy

### Backend Testing

**Unit Tests:**
```python
# tests/services/test_task_generator.py
def test_generate_tasks_for_block():
    # Test task generation creates correct tasks
    block = create_test_block(state="planned")
    tasks = await task_generator.generate_tasks_for_block(block)

    assert len(tasks) >= 5  # At minimum: planting, harvest readiness, daily harvests, completion, cleaning
    assert any(t.taskType == "planting" for t in tasks)
    assert any(t.taskType == "daily_harvest" for t in tasks)

def test_reschedule_tasks_on_timeline_change():
    # Test tasks are rescheduled when timeline changes
    old_timeline = {...}
    new_timeline = {...}  # Harvest starts 2 days earlier

    await task_scheduler.reschedule_block_tasks(block_id, old_timeline, new_timeline)

    tasks = await get_block_tasks(block_id)
    harvest_task = next(t for t in tasks if t.taskType == "daily_harvest")

    assert harvest_task.scheduledDate == new_timeline["harvesting"]["startDate"]

def test_harvest_aggregation():
    # Test midnight aggregation calculates totals correctly
    task = create_harvest_task_with_entries([
        {"userId": "user1", "quantity": 25, "grade": "A"},
        {"userId": "user2", "quantity": 30, "grade": "B"},
        {"userId": "user1", "quantity": 15, "grade": "A"}
    ])

    await harvest_aggregator.aggregate_task(task.taskId)

    updated_task = await get_task(task.taskId)
    assert updated_task.status == "completed"
    assert updated_task.taskData.totalHarvest.totalQuantity == 70
    assert updated_task.taskData.totalHarvest.gradeBreakdown["A"] == 40
    assert len(updated_task.taskData.totalHarvest.contributors) == 2
```

**Integration Tests:**
```python
# tests/api/test_task_endpoints.py
async def test_farmer_can_view_farm_tasks(client, farmer_token):
    response = await client.get(
        "/api/v1/farm/tasks/my-tasks",
        headers={"Authorization": f"Bearer {farmer_token}"}
    )

    assert response.status_code == 200
    assert "data" in response.json()

async def test_farmer_can_add_harvest_entry(client, farmer_token, harvest_task_id):
    response = await client.post(
        f"/api/v1/farm/tasks/{harvest_task_id}/harvest",
        json={"quantity": 25, "grade": "A", "notes": "Morning harvest"},
        headers={"Authorization": f"Bearer {farmer_token}"}
    )

    assert response.status_code == 200
    assert response.json()["data"]["quantity"] == 25

async def test_manager_can_create_custom_task(client, manager_token):
    response = await client.post(
        "/api/v1/farm/tasks",
        json={
            "farmId": "farm-001",
            "blockId": "block-001",
            "title": "Install Irrigation",
            "scheduledDate": "2025-11-20T07:00:00Z",
            "assignedTo": "user-farmer-001"
        },
        headers={"Authorization": f"Bearer {manager_token}"}
    )

    assert response.status_code == 201
    assert response.json()["data"]["taskType"] == "custom"
```

### Frontend Testing

**Component Tests (Jest + React Testing Library):**
```tsx
// tests/components/TaskCompletionModal.test.tsx
describe('TaskCompletionModal', () => {
  it('shows harvest entry form for daily harvest tasks', () => {
    const harvestTask = createMockTask({ taskType: 'daily_harvest' });

    render(<TaskCompletionModal task={harvestTask} />);

    expect(screen.getByLabelText('Quantity (kg)')).toBeInTheDocument();
    expect(screen.getByText('Grade')).toBeInTheDocument();
    expect(screen.getByText('A')).toBeInTheDocument();
  });

  it('allows adding multiple harvest entries', async () => {
    const harvestTask = createMockTask({ taskType: 'daily_harvest' });
    const mockAddEntry = jest.fn();

    render(<TaskCompletionModal task={harvestTask} onAddEntry={mockAddEntry} />);

    // Add first entry
    fireEvent.change(screen.getByLabelText('Quantity (kg)'), { target: { value: '25' } });
    fireEvent.click(screen.getByText('B'));
    fireEvent.click(screen.getByText('âœ“ Add Harvest Entry'));

    await waitFor(() => {
      expect(mockAddEntry).toHaveBeenCalledWith({
        quantity: 25,
        grade: 'B',
        notes: ''
      });
    });
  });
});
```

**E2E Tests (Playwright):**
```typescript
// tests/e2e/operations-flow.spec.ts
test('farmer can complete daily harvest task', async ({ page }) => {
  // Login as farmer
  await page.goto('/login');
  await page.fill('[name="email"]', 'farmer@example.com');
  await page.fill('[name="password"]', 'password123');
  await page.click('button[type="submit"]');

  // Navigate to operations
  await page.click('a[href="/operations"]');
  await expect(page.locator('text=My Tasks')).toBeVisible();

  // Select farm
  await page.click('text=Al Ain Farm');

  // Select block with harvest task
  await page.click('text=F001-002');

  // Click on daily harvest task
  await page.click('text=Daily Harvest - Tomato');

  // Fill harvest form
  await page.fill('[name="quantity"]', '25');
  await page.click('button:has-text("A")');  // Select grade A
  await page.fill('[name="notes"]', 'Morning harvest');

  // Submit
  await page.click('button:has-text("âœ“ Add Harvest Entry")');

  // Verify success
  await expect(page.locator('text=Harvest entry added')).toBeVisible();
  await expect(page.locator('text=25 kg')).toBeVisible();
});
```

**Mobile Responsiveness Testing:**
- Test on real devices: iPhone SE (375px), iPhone 12 (390px), Pixel 5 (393px)
- Test portrait and landscape orientations
- Verify touch targets are at least 44x44px
- Test swipe gestures work smoothly
- Verify keyboard doesn't obscure inputs

---

## Mobile Optimization Techniques

### Touch-Friendly Design
- Minimum touch target: 44x44px (iOS guideline)
- Generous padding around buttons
- Clear visual feedback on touch
- Swipe gestures for common actions

### Performance
- Lazy load images
- Virtualize long task lists (react-window)
- Minimize re-renders with React.memo
- Use optimistic updates for instant feedback

### Offline Capability (Future)
```tsx
// Service worker for caching
// Phase 1: No offline support
// Future: Cache task data, allow offline completion with sync
```

### Native Feel
- Bottom sheet modals (react-spring-bottom-sheet)
- Pull-to-refresh (react-pull-to-refresh)
- Smooth animations (framer-motion)
- Haptic feedback on actions (navigator.vibrate())

---

## Security Considerations

### Authorization
- Farmers can only see farms they're assigned to
- Farmers can complete any auto-task on their assigned farms
- Farmers can only complete custom tasks assigned to them
- Managers can see all farm tasks and complete any
- Only managers can create custom tasks
- Only managers can assign/remove farmers

### Data Validation
- Validate harvest quantity > 0
- Validate grade is one of: A, B, C, D, Waste
- Sanitize user input (notes, alert messages)
- Validate task belongs to farmer's assigned farm

### Audit Trail
- Log who completed each task
- Log all harvest entries with user ID and timestamp
- Track alert creation, acknowledgment, resolution
- Retain task history for 6 months

---

## Future Enhancements

### Offline Support
- Service worker for caching
- IndexedDB for local storage
- Background sync for task completion
- Conflict resolution for multiple entries

### Advanced Features
- Task templates (managers create reusable task templates)
- Task dependencies (task B can't start until task A completes)
- Recurring custom tasks (weekly equipment check)
- Task reminders (1 hour before due)
- Photo annotations (mark issues on photos)
- Voice notes for task completion
- GPS verification (confirm farmer is at farm location)

### Analytics
- Farmer performance dashboard
- Task completion rates
- Average harvest per block/farmer
- Alert response time
- Productivity trends

---

## Success Metrics

### KPIs to Track
1. **Task Completion Rate** - % of tasks completed on time
2. **Average Harvest per Task** - kg harvested per daily harvest task
3. **Alert Response Time** - Time from alert creation to resolution
4. **Farmer Productivity** - Tasks completed per farmer per day
5. **Grade Distribution** - % of harvest in each grade (A/B/C/D/Waste)
6. **Mobile Usage** - % of tasks completed on mobile vs desktop

### Target Metrics (3 months after launch)
- Task completion rate > 90%
- Alert response time < 4 hours
- > 80% of farmer interactions on mobile
- Grade A harvest > 60% of total

---

## Deployment Checklist

**Backend:**
- [ ] Database indexes created
- [ ] APScheduler configured for midnight aggregation
- [ ] Push notification service integrated
- [ ] API endpoints tested
- [ ] Authorization verified
- [ ] Error logging configured

**Frontend:**
- [ ] Responsive design tested (320px - 1920px)
- [ ] Touch interactions tested on real devices
- [ ] Loading states implemented
- [ ] Error boundaries added
- [ ] Accessibility verified (WCAG 2.1 AA)
- [ ] Performance optimized (Lighthouse > 90)

**Documentation:**
- [ ] API documentation updated
- [ ] User guide for farmers created
- [ ] Manager guide created
- [ ] DevLog entry created

---

## Questions Answered

1. âœ… **Task Assignment:** Auto-generated tasks visible to all farmers on farm; custom tasks can be assigned to specific farmers
2. âœ… **Harvest Grades:** A, B, C, D, Waste
3. âœ… **Photos:** Optional for all tasks
4. âœ… **Notifications:** Yes, push notifications enabled
5. âœ… **Task History:** 6-month retention
6. âœ… **Offline Support:** Not in Phase 1 (future enhancement)
7. âœ… **Early Harvest:** Auto-cancel remaining daily harvest tasks
8. âœ… **Multiple Harvests:** Daily task accumulates entries until midnight; tracks all contributing farmers

---

## Estimated Timeline

**Total:** 4-5 weeks for full implementation

- **Week 1:** Database schema + Task generation system
- **Week 2:** Backend APIs + Harvest aggregation
- **Week 3:** Frontend mobile UI
- **Week 4:** Manager integration + Notifications
- **Week 5:** Testing + Polish + Deployment

**Team Size:** 1-2 developers

---

## Next Steps

1. **Review and Approve Plan** - Get stakeholder approval
2. **Create Database Schemas** - Set up MongoDB collections
3. **Start Phase 1** - Begin backend foundation
4. **Iterative Development** - Ship features progressively
5. **User Testing** - Test with real farmers early

**Ready to start implementation?** Let me know if you want to proceed with Phase 1!
